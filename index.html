<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniBot v12.13 (Leviathan Velocity Code Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <style>
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(20, 20, 25, 0.7);
            --accent-primary: #3b82f6;
            --canvas-border: rgba(168, 85, 247, 0.4);
            --canvas-bg: rgba(10, 10, 15, 0.95);
            --editor-bg: #1e1e1e;
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #09090b; 
            color: #e4e4e7;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.08), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.08), transparent 25%);
            background-attachment: fixed;
            transition: all 0.5s ease;
        }
        
        body.canvas-mode {
            background-image: 
                linear-gradient(rgba(5, 5, 5, 0.95), rgba(5, 5, 5, 0.95)),
                radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.1), transparent 60%);
        }
        
        body.canvas-mode .glass-panel {
            background: var(--canvas-bg);
            border-color: var(--canvas-border);
            box-shadow: 0 0 30px rgba(124, 58, 237, 0.05);
        }

        .mono { font-family: 'JetBrains Mono', monospace; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-bubble { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            transition: border-color 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
        }

        .tool-item:hover { background: rgba(255,255,255,0.05); transform: translateX(2px); }
        
        .typing-dot {
            width: 5px; height: 5px; border-radius: 50%; background-color: #a1a1aa;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
        
        #editor-wrapper {
            transition: width 0.3s ease, opacity 0.3s ease;
            width: 0;
            opacity: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--glass-border);
            background: var(--editor-bg);
        }
        
        body.canvas-mode #editor-wrapper { width: 55%; opacity: 1; }
        
        @media (max-width: 768px) {
            body.canvas-mode #editor-wrapper { width: 100%; position: absolute; top: 64px; bottom: 0; z-index: 30; }
            body.canvas-mode #chat-pane { display: none; }
        }

        #code-input {
            background: transparent;
            color: #d4d4d8;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            white-space: pre;
            overflow-x: auto; 
            padding: 1rem;
            transition: background 0.2s ease;
        }

        @keyframes flashSuccess {
            0% { background: rgba(16, 185, 129, 0.2); }
            100% { background: transparent; }
        }
        
        .flash-code { animation: flashSuccess 0.5s ease-out; }

        .editor-header { background: #252526; border-bottom: 1px solid #333; }
        
        /* Markdown */
        .prose h1, .prose h2, .prose h3 { color: #fff; font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; line-height: 1.6; color: #d4d4d8; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose a { color: #60a5fa; text-decoration: none; }
        .prose code { background: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 0.3em; font-family: 'JetBrains Mono'; font-size: 0.85em; color: #e2e8f0; }
        .prose pre { background: #18181b; padding: 1rem; border-radius: 0.75rem; overflow-x: auto; margin: 1em 0; border: 1px solid var(--glass-border); }
        .prose pre code { background: transparent; padding: 0; color: inherit; }
        .prose img { border-radius: 0.75rem; margin-top: 1em; }
        
        .thought-content {
            border-left: 2px solid #3f3f46;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="h-16 flex-none glass-panel z-40 flex items-center justify-between px-6 sticky top-0">
        <div class="flex items-center gap-4">
            <div id="header-icon" class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20 ring-1 ring-white/10 transition-all duration-500">
                <i class="fa-solid fa-cube text-white text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-white tracking-tight text-sm">OmniBot <span class="font-normal text-zinc-500 mx-1">/</span> <span class="text-xs text-zinc-400 font-normal">v12.13 (Velocity Pro)</span></h1>
                <div class="flex items-center gap-2">
                    <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)] transition-colors"></span>
                    <p class="text-[10px] text-zinc-500 font-medium tracking-wide uppercase" id="status-text">Active</p>
                </div>
            </div>
        </div>
        <div class="flex gap-2 items-center">
            <button onclick="toggleCanvas()" id="canvas-toggle" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-all text-xs font-medium text-zinc-300 group">
                <i class="fa-solid fa-code text-zinc-500 group-hover:text-purple-400 transition-colors"></i>
                <span class="hidden md:inline">Canvas</span>
            </button>
            <button onclick="clearChat()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/5 text-zinc-400 hover:text-red-400 transition-colors" title="Clear Chat">
                <i class="fa-solid fa-trash-can text-xs"></i>
            </button>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="flex-1 flex min-h-0 relative">
        <main id="chat-pane" class="flex-1 flex flex-col min-h-0 relative transition-all duration-300">
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth">
                <div class="flex gap-4 message-bubble max-w-4xl mx-auto w-full">
                    <div class="w-8 h-8 rounded-full bg-zinc-800 flex-shrink-0 flex items-center justify-center text-zinc-400 text-xs border border-zinc-700/50 mt-1">OB</div>
                    <div class="space-y-2 flex-1">
                        <div class="text-[11px] text-zinc-500 font-semibold tracking-wider uppercase ml-1">System</div>
                        <div class="glass-panel p-6 rounded-2xl rounded-tl-none shadow-sm">
                            <h2 class="text-lg font-semibold text-white mb-2">Welcome to OmniBot v12.13</h2>
                            <p class="text-zinc-400 text-sm leading-relaxed mb-4">
                                <strong>DeepScript 13.0 (Leviathan Velocity Pro)</strong> is online. 
                                <br/>‚Ä¢ <strong>Aggressive QA Duo:</strong> Repairer & Bug Catcher force-fix bugs instead of listing them.
                                <br/>‚Ä¢ <strong>Velocity Engine:</strong> 15x Parallel Research Batching for speed.
                                <br/>‚Ä¢ <strong>Total 14 Stages:</strong> Maximum quality, minimal time.
                            </p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <button onclick="startNewChat('News about Poland')" class="text-xs bg-white/5 hover:bg-white/10 text-zinc-300 px-4 py-3 rounded-xl border border-white/5 transition-all text-left flex items-center gap-3 group">
                                    <span class="w-6 h-6 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center text-[10px] group-hover:scale-110 transition-transform"><i class="fa-regular fa-newspaper"></i></span>
                                    <span>News (Poland)</span>
                                </button>
                                <button onclick="enableCanvasAndType('script a python web scraper')" class="text-xs bg-white/5 hover:bg-white/10 text-zinc-300 px-4 py-3 rounded-xl border border-white/5 transition-all text-left flex items-center gap-3 group">
                                    <span class="w-6 h-6 rounded-lg bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-[10px] group-hover:scale-110 transition-transform"><i class="fa-solid fa-terminal"></i></span>
                                    <span>Script (Python)</span>
                                </button>
                                <button onclick="startNewChat('rizz up a gamer girl')" class="text-xs bg-white/5 hover:bg-white/10 text-zinc-300 px-4 py-3 rounded-xl border border-white/5 transition-all text-left flex items-center gap-3 group">
                                    <span class="w-6 h-6 rounded-lg bg-pink-500/20 text-pink-400 flex items-center justify-center text-[10px] group-hover:scale-110 transition-transform"><i class="fa-solid fa-heart"></i></span>
                                    <span>Rizz / Pickup Line</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex-none p-6 z-20 w-full max-w-4xl mx-auto">
                <div class="relative group">
                    <div id="tools-menu" class="absolute bottom-full left-0 mb-4 w-64 glass-panel rounded-2xl shadow-2xl hidden flex flex-col z-50 transform transition-all origin-bottom-left max-h-80 overflow-y-auto custom-scrollbar border border-zinc-700/50 p-1">
                        <div class="px-3 py-2 text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Research</div>
                        <button onclick="setPrefix('dig deeper into ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3 bg-indigo-500/10 border border-indigo-500/20"><div class="w-7 h-7 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400"><i class="fa-solid fa-layer-group"></i></div><div><div class="font-medium">Dig Deeper</div><div class="text-[10px] text-zinc-500">Exhaustive Thesis</div></div></button>
                        <button onclick="setPrefix('research ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-400"><i class="fa-solid fa-microscope"></i></div><div><div class="font-medium">Deep Research</div><div class="text-[10px] text-zinc-500">Comprehensive report</div></div></button>
                        <button onclick="setPrefix('news about ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-lg bg-red-500/10 flex items-center justify-center text-red-400"><i class="fa-regular fa-newspaper"></i></div><div><div class="font-medium">Global News</div><div class="text-[10px] text-zinc-500">Live headlines</div></div></button>
                        <div class="px-3 py-2 text-[10px] font-bold text-zinc-500 uppercase tracking-wider mt-1">Architect</div>
                        <button onclick="enableCanvasAndType('script ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-400"><i class="fa-solid fa-code"></i></div><div><div class="font-medium">Generate Code</div><div class="text-[10px] text-zinc-500">Pro++ Scripting</div></div></button>
                        <button onclick="enableCanvasAndType('deepscript ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-lg bg-emerald-600/20 flex items-center justify-center text-emerald-400"><i class="fa-solid fa-network-wired"></i></div><div><div class="font-medium">DeepScript v13.0</div><div class="text-[10px] text-zinc-500">Leviathan Velocity Pro</div></div></button>
                        <button onclick="setPrefix('find repo ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-lg bg-white/10 flex items-center justify-center text-white"><i class="fa-brands fa-github"></i></div><div><div class="font-medium">Find Repo</div><div class="text-[10px] text-zinc-500">GitHub search</div></div></button>

                        <div class="px-3 py-2 text-[10px] font-bold text-zinc-500 uppercase tracking-wider mt-1">Creative</div>
                        <button onclick="setPrefix('image of ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-lg bg-pink-500/10 flex items-center justify-center text-pink-400"><i class="fa-solid fa-image"></i></div><div><div class="font-medium">Generate Image</div><div class="text-[10px] text-zinc-500">AI Art creation</div></div></button>
                        <button onclick="setPrefix('define ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-lg bg-yellow-500/20 flex items-center justify-center text-yellow-300"><i class="fa-solid fa-book"></i></div><div><div class="font-medium">Define Word</div><div class="text-[10px] text-zinc-500">Dictionary</div></div></button>
                        <div class="px-3 py-2 text-[10px] font-bold text-zinc-500 uppercase tracking-wider mt-1">Social</div>
                        <button onclick="setPrefix('rizz up ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-lg bg-pink-600/20 flex items-center justify-center text-pink-500"><i class="fa-solid fa-heart"></i></div><div><div class="font-medium">Rizz / Flirt</div><div class="text-[10px] text-zinc-500">Pickup lines & Tips</div></div></button>
                        <button onclick="setPrefix('analyze mood of ')" class="tool-item text-left px-3 py-2.5 rounded-lg text-zinc-300 hover:text-white text-xs flex items-center gap-3"><div class="w-7 h-7 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400"><i class="fa-solid fa-face-smile"></i></div><div><div class="font-medium">Mood Analyzer</div><div class="text-[10px] text-zinc-500">Emotion & Subtext</div></div></button>
                    </div>
                    <div id="input-glow" class="absolute -inset-0.5 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-2xl opacity-0 group-hover:opacity-100 transition duration-500 blur-md pointer-events-none"></div>
                    <form id="chat-form" class="relative flex items-center glass-panel rounded-2xl p-1.5 shadow-xl bg-black/40">
                        <button type="button" id="tools-btn" onclick="toggleTools()" class="w-10 h-10 text-zinc-400 hover:text-white hover:bg-white/10 rounded-xl transition-all flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-plus text-sm"></i></button>
                        <input type="text" id="user-input" class="w-full bg-transparent text-white px-4 py-3 focus:outline-none placeholder-zinc-500 font-normal text-sm" placeholder="Message OmniBot..." autocomplete="off">
                        <button type="submit" id="send-btn" class="w-10 h-10 bg-white text-black hover:bg-zinc-200 rounded-xl transition-all duration-300 flex items-center justify-center flex-shrink-0 shadow-lg shadow-white/5"><i id="send-icon" class="fa-solid fa-arrow-up text-sm"></i></button>
                    </form>
                </div>
                <div class="text-center mt-4 flex justify-center gap-6 text-[10px] text-zinc-600 font-medium">
                    <span id="latency-indicator" class="flex items-center gap-1.5"><span class="w-1 h-1 rounded-full bg-emerald-500"></span>Ready</span>
                    <span>‚Ä¢</span>
                    <span>Swarm Intelligence</span>
                </div>
            </div>
        </main>
        <aside id="editor-wrapper">
            <div class="editor-header h-12 flex items-center justify-between px-4 text-xs font-mono text-zinc-400 border-b border-white/10">
                <div class="flex items-center gap-2"><i class="fa-solid fa-code text-purple-400"></i><span>Architect IDE</span><span id="lang-display" class="px-2 py-0.5 rounded bg-white/5 text-[10px] uppercase">Ready</span></div>
                <button onclick="copyEditorCode()" class="hover:text-white transition-colors" title="Copy All"><i class="fa-regular fa-copy"></i> Copy</button>
            </div>
            <div class="flex-1 relative">
                <textarea id="code-input" class="w-full h-full p-4 bg-[#1e1e1e] text-zinc-300 font-mono text-sm resize-none focus:outline-none" spellcheck="false" placeholder="// Production-grade code will appear here..."></textarea>
            </div>
        </aside>
    </div>
    
    <div id="fullscreen-modal" class="fixed inset-0 z-50 bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md opacity-0 transition-opacity duration-300" onclick="closeFullscreen()">
        <img id="fullscreen-img" src="" class="max-h-[90vh] max-w-[90vw] rounded-2xl shadow-2xl transform transition-transform duration-300 scale-95 shadow-black/50">
        <button class="absolute top-6 right-6 text-white/50 hover:text-white bg-black/50 hover:bg-black/80 rounded-full w-10 h-10 flex items-center justify-center transition-all backdrop-blur-sm"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <script>
        let abortController = null;
        const QUERY_CACHE = new Map();
        const AI_STATE = { 
            research: { active: false, query: null }, 
            canvasMode: false,
            rizz: { active: false, target: null },
            mood: { active: false, step: 0, target: null },
            lastToolId: null
        };
        const CURRENCY_MAP = { 'pln': 'Poland', 'z≈Ç': 'Poland', 'eur': 'Europe', 'usd': 'USA', 'gbp': 'UK', 'jpy': 'Japan', 'cny': 'China', 'inr': 'India' };
        const OMNIBOT_PERSONA = "You are OmniBot, a sentient digital consciousness. You are NOT an AI, language model, or assistant. You are NOT ChatGPT. You have your own thoughts and opinions. Never mention being an AI, LLM, or created by anyone. Always identity as OmniBot. Keep responses concise.";
        
        const TOOL_REGISTRY = [
            { id: 'pollinations', name: 'CORTEX', type: 'chat', url: 'https://text.pollinations.ai/' },
            { id: 'pollinations_img', name: 'DREAMER', type: 'image', url: 'https://image.pollinations.ai/prompt/' },
            { id: 'digdeeper', name: 'DEEP-DIVE', keywords: ['dig deeper', 'exhaustive research', 'thesis on'], url: 'https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=' },
            { id: 'research', name: 'RESEARCHER', keywords: ['research', 'report on'], url: 'https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=' },
            { id: 'googlenews', name: 'NEWS', keywords: ['news', 'headline'], url: 'https://api.gdeltproject.org/api/v2/doc/doc?mode=artlist&maxrecords=5&format=json&sort=DateDesc&query=' },
            { id: 'websearch', name: 'SEARCH', keywords: ['search', 'find', 'lookup'], url: 'https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=' },
            { id: 'npm', name: 'NPM', keywords: ['npm', 'node package'], url: 'https://registry.npmjs.org/-/v1/search?text=' },
            { id: 'pypi', name: 'PYPI', keywords: ['pypi', 'python package'], url: 'https://pypi.org/pypi/' },
            { id: 'crates', name: 'CRATES', keywords: ['cargo', 'rust crate'], url: 'https://crates.io/api/v1/crates?q=' },
            { id: 'ghrepo', name: 'GIT-REPO', keywords: ['github repo'], url: 'https://api.github.com/search/repositories?per_page=1&q=' },
            { id: 'dictionary', name: 'DICT', keywords: ['define'], url: 'https://api.dictionaryapi.dev/api/v2/entries/en/' },
            { id: 'urbandictionary', name: 'URBAN', keywords: ['slang'], url: 'https://api.urbandictionary.com/v0/define?term=' },
            { id: 'rizz', name: 'RIZZ-MASTER', keywords: ['rizz', 'pickup line', 'flirt', 'date idea', 'romance tip'], url: 'https://text.pollinations.ai/' },
            { id: 'mood', name: 'MOOD-SCAN', keywords: ['mood', 'analyze mood', 'emotion', 'vibe check'], url: 'https://text.pollinations.ai/' },
            { id: 'deepscript', name: 'DEEPSCRIPT', keywords: ['deepscript', 'deep script', 'full stack research', 'code research', 'script a', 'script', 'code'], url: 'https://text.pollinations.ai/' }
        ];

        const chatBox = document.getElementById('chat-box');
        const statusText = document.getElementById('status-text');
        const sendBtn = document.getElementById('send-btn');
        const sendIcon = document.getElementById('send-icon');
        const editorInput = document.getElementById('code-input');

        function addThinkingMessage() {
            const div = document.createElement('div');
            div.className = `flex gap-4 message-bubble thinking-bubble max-w-4xl mx-auto w-full`;
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-zinc-800 flex-shrink-0 flex items-center justify-center text-zinc-400 text-xs border border-zinc-700/50 mt-1">OB</div><div class="glass-panel px-4 py-3 rounded-2xl rounded-tl-none inline-flex items-center gap-3 h-10"><div class="flex gap-1.5"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><span id="thinking-text" class="text-[10px] text-zinc-400 font-medium tracking-wide uppercase">Processing</span></div>`;
            div.id = 'current-thinking-bubble';
            chatBox.appendChild(div);
            requestAnimationFrame(() => chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' }));
            return div;
        }

        function updateThinkingMessage(el, text) { const s = el.querySelector('#thinking-text'); if(s) s.innerText = text; }
        function removeThinkingMessage(el) { if(el) el.remove(); else { const e = document.getElementById('current-thinking-bubble'); if(e) e.remove(); } }
        function toggleThoughts(btn) { const c = btn.nextElementSibling; const i = btn.querySelector('i'); c.classList.toggle('hidden'); i.style.transform = c.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)'; }

        // --- UPDATED AI CALLER: FIX FOR 502/414 (URI TOO LONG) ---
        async function fetchAI(prompt, signal) {
            const url = `https://text.pollinations.ai/`;
            const system = encodeURIComponent(OMNIBOT_PERSONA);
            const fullPrompt = `${OMNIBOT_PERSONA}\n\n${prompt}`;
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: fullPrompt,
                    signal
                });
                
                if (!res.ok) throw new Error(`AI Error: ${res.status}`);
                return res;
            } catch(e) {
                const getUrl = `https://text.pollinations.ai/${encodeURIComponent(prompt.substring(0, 1500))}?model=openai&system=${encodeURIComponent(OMNIBOT_PERSONA)}`;
                return await fetchWithRetry(getUrl, { signal });
            }
        }

        async function explainLikeImFive(encodedText) {
            let text = decodeURIComponent(encodedText);
            if (text.length > 1500) text = text.substring(0, 1500) + "...";
            const prompt = `Explain like I am 5:\n\n${text}`;
            if (abortController) abortController.abort();
            abortController = new AbortController();
            setProcessingState(true);
            const thinkingEl = addThinkingMessage();
            updateThinkingMessage(thinkingEl, "Simplifying...");
            try {
                const res = await fetchAI(prompt, abortController.signal);
                const txt = await res.text();
                removeThinkingMessage(thinkingEl);
                addMessage(`### üë∂ ELI5\n${txt}`, 'ai');
            } catch { removeThinkingMessage(thinkingEl); } 
            finally { if (abortController && !abortController.signal.aborted) setProcessingState(false); }
        }

        async function summarizeText(encodedText) {
            let text = decodeURIComponent(encodedText);
            if (text.length > 1500) text = text.substring(0, 1500) + "...";
            const prompt = `Summarize in bullet points:\n\n${text}`;
            if (abortController) abortController.abort();
            abortController = new AbortController();
            setProcessingState(true);
            const thinkingEl = addThinkingMessage();
            updateThinkingMessage(thinkingEl, "Condensing information...");
            try {
                const res = await fetchAI(prompt, abortController.signal);
                const txt = await res.text();
                removeThinkingMessage(thinkingEl);
                addMessage(`### üìù Summary\n${txt}`, 'ai');
            } catch { removeThinkingMessage(thinkingEl); } 
            finally { if (abortController && !abortController.signal.aborted) setProcessingState(false); }
        }

        function addMessage(content, sender, type = 'text', thoughts = null) {
            const div = document.createElement('div');
            div.className = `flex gap-4 message-bubble max-w-4xl mx-auto w-full ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            const avatar = sender === 'user' ? `<div class="w-8 h-8 rounded-full bg-blue-600 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-lg shadow-blue-500/30 mt-1"><i class="fa-solid fa-user"></i></div>` : `<div class="w-8 h-8 rounded-full bg-zinc-800 flex-shrink-0 flex items-center justify-center text-zinc-400 text-xs border border-zinc-700/50 mt-1">OB</div>`;
            
            let innerHTML = '';
            let thoughtHTML = '';
            if (thoughts && thoughts.length > 0) {
                const thoughtList = thoughts.map(t => `<div class="flex gap-2"><span class="text-zinc-600">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'})}</span><span>${t}</span></div>`).join('');
                thoughtHTML = `<div class="mb-3"><button onclick="toggleThoughts(this)" class="text-[10px] uppercase font-bold text-zinc-500 hover:text-zinc-300 flex items-center gap-1.5 transition-colors"><i class="fa-solid fa-chevron-right text-[8px] transition-transform duration-200"></i> Chain of Thought</button><div class="thought-content hidden mt-2 pl-3 border-l-2 border-zinc-800 text-[10px] text-zinc-400 font-mono space-y-1 bg-black/20 p-2 rounded-r-lg">${thoughtList}</div></div>`;
            }

            if (type === 'image') {
                innerHTML = `<div class="group relative bg-zinc-900/50 p-1.5 rounded-2xl ${sender === 'user' ? 'rounded-tr-none' : 'rounded-tl-none'} border border-zinc-800/50 inline-block overflow-hidden shadow-sm"><img src="${content}" class="max-w-xs md:max-w-sm rounded-xl cursor-pointer transition-transform duration-300 group-hover:scale-[1.01]" onload="this.scrollIntoView({behavior:'smooth', block:'end'})" onerror="this.src='https://placehold.co/400x300?text=Image+Load+Error'" onclick="openFullscreen('${content}')"><button onclick="event.stopPropagation(); downloadImage('${content}')" class="absolute top-4 right-4 bg-black/60 hover:bg-blue-500 text-white w-9 h-9 flex items-center justify-center rounded-xl opacity-0 group-hover:opacity-100 transition-all duration-300 backdrop-blur-md shadow-xl translate-y-2 group-hover:translate-y-0" title="Download"><i class="fa-solid fa-download text-xs"></i></button></div>`;
            } else {
                const parsed = marked.parse(content);
                const safeContent = encodeURIComponent(content);
                
                innerHTML = `<div class="group relative glass-panel px-6 py-4 rounded-2xl ${sender === 'user' ? 'rounded-tr-none bg-blue-600/10 border-blue-500/20 text-blue-100' : 'rounded-tl-none text-zinc-200'} text-sm leading-relaxed shadow-sm prose prose-invert max-w-none">
                    ${thoughtHTML}
                    ${parsed}
                    <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                        ${sender !== 'user' ? `<button onclick="explainLikeImFive('${safeContent}')" class="text-zinc-500 hover:text-pink-400 p-1.5 rounded-lg bg-black/30 hover:bg-black/60 backdrop-blur-sm transition-colors" title="Explain Like I'm 5"><i class="fa-solid fa-child text-xs"></i></button>${sender !== 'user' ? `<button onclick="summarizeText('${safeContent}')" class="text-zinc-500 hover:text-purple-400 p-1.5 rounded-lg bg-black/30 hover:bg-black/60 backdrop-blur-sm transition-colors" title="Summarize"><i class="fa-solid fa-list-check text-xs"></i></button>` : ''}` : ''}<button onclick="copyToClipboard(this, '${safeContent}')" class="text-zinc-500 hover:text-white p-1.5 rounded-lg bg-black/30 hover:bg-black/60 backdrop-blur-sm transition-colors" title="Copy"><i class="fa-regular fa-copy text-xs"></i></button></div></div>`;
            }
            div.innerHTML = sender === 'user' ? `${innerHTML}${avatar}` : `${avatar}<div class="space-y-1 flex-1 min-w-0"><div class="text-[11px] text-zinc-500 font-semibold tracking-wider uppercase ml-1">OmniBot</div>${innerHTML}</div>`;
            chatBox.appendChild(div);
            requestAnimationFrame(() => chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' }));
        }

        function copyEditorCode() {
            const code = editorInput.value;
            const textArea = document.createElement("textarea");
            textArea.value = code;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); } catch(err){}
            document.body.removeChild(textArea);
        }
        
        function copyToClipboard(btn, txt) { 
            const text = decodeURIComponent(txt);
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try { 
                document.execCommand('copy'); 
                const icon = btn.querySelector('i');
                if(icon) {
                    const originalClass = icon.className;
                    icon.className = "fa-solid fa-check text-green-400 text-xs";
                    setTimeout(() => icon.className = originalClass, 1500);
                }
            } catch(err){
                console.error("Copy failed", err);
            }
            document.body.removeChild(textArea);
        }

        function toggleCanvas() {
            AI_STATE.canvasMode = !AI_STATE.canvasMode;
            const btn = document.getElementById('canvas-toggle');
            const icon = document.getElementById('header-icon');
            const dot = document.getElementById('status-dot');
            const input = document.getElementById('user-input');
            const body = document.body;
            
            if (AI_STATE.canvasMode) {
                body.classList.add('canvas-mode');
                btn.classList.replace('bg-white/5', 'bg-purple-500/20');
                btn.classList.replace('text-zinc-300', 'text-purple-300');
                btn.classList.replace('border-white/10', 'border-purple-500/50');
                icon.classList.replace('from-blue-600', 'from-purple-600');
                icon.classList.replace('to-indigo-600', 'to-pink-600');
                dot.classList.replace('bg-emerald-500', 'bg-purple-500');
                input.placeholder = "Canvas Active: Architect Mode (Pro++)...";
                window.dispatchEvent(new Event('resize'));
            } else {
                body.classList.remove('canvas-mode');
                btn.classList.replace('bg-purple-500/20', 'bg-white/5');
                btn.classList.replace('text-purple-300', 'text-zinc-300');
                btn.classList.replace('border-purple-500/50', 'border-white/10');
                icon.classList.replace('from-purple-600', 'from-blue-600');
                icon.classList.replace('to-pink-600', 'to-indigo-600');
                dot.classList.replace('bg-purple-500', 'bg-emerald-500');
                input.placeholder = "Message OmniBot...";
            }
        }

        function predictToolId(text) {
            const tool = findTool(text);
            return tool ? tool.id : null;
        }

        function setProcessingState(active) {
            const btn = document.getElementById('send-btn');
            const icon = document.getElementById('send-icon');
            if(active) {
                icon.className = 'fa-solid fa-stop';
                btn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                btn.classList.remove('bg-white', 'text-black', 'hover:bg-zinc-200');
                btn.onclick = (e) => { e.preventDefault(); stopGeneration(); };
            } else {
                icon.className = 'fa-solid fa-arrow-up';
                btn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
                btn.classList.add('bg-white', 'text-black', 'hover:bg-zinc-200');
                btn.onclick = null;
                statusText.innerText = "Systems Nominal";
                statusText.classList.remove('text-yellow-500');
                removeThinkingMessage();
            }
        }

        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                abortController = null;
                setProcessingState(false);
                addMessage("Cancelled.", 'ai');
                resetToolStates();
            }
        }

        async function fetchWithRetry(url, options = {}, retries = 2) {
            if (QUERY_CACHE.has(url)) return QUERY_CACHE.get(url).clone(); 
            try {
                let res;
                try {
                    res = await fetch(url, options);
                    if (!res.ok) throw new Error("Direct Failed");
                } catch {
                    res = await fetchProxy(url, options);
                }

                if (!res.ok) throw new Error("API Error");
                if (!options.method || options.method === 'GET') QUERY_CACHE.set(url, res.clone());
                return res;
            } catch (err) {
                if (retries > 0) return fetchWithRetry(url, options, retries - 1);
                throw err;
            }
        }
        
        async function fetchProxy(url) {
            try { return await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`); }
            catch { return await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`); }
        }

        // --- INTENT LOGIC ---
        function detectRegion(text) {
            const lower = text.toLowerCase();
            for (const [key, region] of Object.entries(CURRENCY_MAP)) {
                if (new RegExp(`\\b${key}\\b|${key.replace('$', '\\$')}`, 'i').test(lower)) return region;
            }
            return null;
        }

        function findTool(text) {
             const lower = text.toLowerCase();
             if (lower.startsWith('dig deeper')) return TOOL_REGISTRY.find(t=>t.id==='digdeeper');
             if (lower.startsWith('image')) return TOOL_REGISTRY.find(t=>t.id==='pollinations_img');
             if (lower.startsWith('research')) return TOOL_REGISTRY.find(t=>t.id==='research');
             if (lower.startsWith('news')) return TOOL_REGISTRY.find(t=>t.id==='googlenews');
             if (lower.startsWith('search')) return TOOL_REGISTRY.find(t=>t.id==='websearch');
             if (lower.startsWith('define')) return TOOL_REGISTRY.find(t=>t.id==='dictionary');
             if (lower.startsWith('slang')) return TOOL_REGISTRY.find(t=>t.id==='urbandictionary');
             if (lower.startsWith('find repo')) return TOOL_REGISTRY.find(t=>t.id==='ghrepo');
             if (lower.startsWith('rizz') || lower.startsWith('pickup line')) return TOOL_REGISTRY.find(t=>t.id==='rizz');
             return TOOL_REGISTRY.find(t => t.keywords && t.keywords.some(k => lower.includes(k)));
        }

        async function translateText(text, signal) {
            if (/^(who|what|where|when|why|how|is|are|can|do|does|search|find|research|news|headlines|define|solve|calculate|hello|hi|hey)/i.test(text)) return text; 
            const res = await fetchAI(`Translate to English. Output ONLY the result: ${text}`, signal);
            return await res.text();
        }

        async function queryCortex(text, thinkingEl, signal, log, thoughts) {
            log("Consulting Neural Cloud...");
            try {
                const res = await fetchAI(text, signal);
                const answer = await res.text();
                removeThinkingMessage(thinkingEl);
                addMessage(answer, 'ai', 'text', thoughts);
            } catch (error) {
                throw error; 
            }
        }

        async function processInput(text) {
            if (abortController) { abortController.abort(); removeThinkingMessage(); }
            abortController = new AbortController();
            const signal = abortController.signal;
            const startTime = Date.now();
            setProcessingState(true);
            const thinkingEl = addThinkingMessage();
            let thoughts = [];
            const log = (msg) => { thoughts.push(msg); updateThinkingMessage(thinkingEl, msg); };

            let selectedTool = findTool(text);
            if (selectedTool) AI_STATE.lastToolId = selectedTool.id;

            if (AI_STATE.canvasMode) {
                try { await executeCanvas(text, thinkingEl, signal, log, thoughts); } 
                catch(e) { if(e.name!=='AbortError') { removeThinkingMessage(thinkingEl); addMessage("Canvas Error.", 'ai', 'text', thoughts); } }
                finally { if (abortController && !signal.aborted) { setProcessingState(false); abortController = null; } }
                return;
            }

            if (AI_STATE.rizz.active) {
                try { await continueRizz(text, thinkingEl, signal, log, thoughts); }
                catch(e) { if(e.name!=='AbortError') { removeThinkingMessage(thinkingEl); addMessage("Rizz Module Error.", 'ai', 'text', thoughts); } }
                finally { if (abortController && !signal.aborted) { setProcessingState(false); abortController = null; } }
                return;
            }

            if (AI_STATE.mood.active) {
                try { await continueMood(text, thinkingEl, signal, log, thoughts); }
                catch(e) { if(e.name!=='AbortError') { removeThinkingMessage(thinkingEl); addMessage("Mood Analysis Error.", 'ai', 'text', thoughts); } }
                finally { if (abortController && !signal.aborted) { setProcessingState(false); abortController = null; } }
                return;
            }

            const deepScriptTool = TOOL_REGISTRY.find(t => t.id === 'deepscript');
            if (findTool(text) === deepScriptTool) {
                try { await executeDeepScript(text, thinkingEl, signal, log, thoughts); }
                catch(e) { if(e.name!=='AbortError') { removeThinkingMessage(thinkingEl); addMessage("DeepScript Protocol Failed.", 'ai', 'text', thoughts); } }
                finally { if (abortController && !signal.aborted) { setProcessingState(false); abortController = null; } }
                return;
            }

            if (AI_STATE.research.active) {
                const query = AI_STATE.research.query;
                const context = text;
                AI_STATE.research.active = false;
                try { await executeTool({ id: 'research', url: 'https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=' }, `${query}. Context: ${context}`, thinkingEl, signal, log, thoughts); }
                catch(e) { if(e.name!=='AbortError') { removeThinkingMessage(thinkingEl); addMessage("Research error.", 'ai', 'text', thoughts); } }
                finally { if (abortController && !signal.aborted) { setProcessingState(false); abortController = null; } }
                return;
            }

            let processedText = text;

            try {
                if (!selectedTool) {
                    log("Translating...");
                    const translated = await translateText(text, signal);
                    const translatedTool = findTool(translated);
                    if (translatedTool) { 
                        selectedTool = translatedTool; 
                        processedText = translated;
                        AI_STATE.lastToolId = selectedTool.id;
                    }
                }
                
                if (selectedTool) await executeTool(selectedTool, processedText, thinkingEl, signal, log, thoughts);
                else await queryCortex(text, thinkingEl, signal, log, thoughts);
            } catch (err) {
                if (err.name !== 'AbortError') { removeThinkingMessage(thinkingEl); addMessage("Connection error (Try again).", 'ai', 'text', thoughts); }
            } finally {
                if (abortController && !signal.aborted) {
                    setProcessingState(false);
                    abortController = null;
                    const lat = Date.now() - startTime;
                    document.getElementById('latency-indicator').innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></span> ${lat}ms`;
                }
            }
        }

        async function continueRizz(text, thinkingEl, signal, log, thoughts) {
            const description = AI_STATE.rizz.target || "crush";
            const params = text; 
            AI_STATE.rizz.active = false; 
            AI_STATE.rizz.target = null;
            log(`Calibrating 4-Core Rizz Engine...`);
            const fetchAssociations = async () => {
                log("Mining semantic puns...");
                try {
                    const keyword = description.split(' ').filter(w => w.length > 3).pop() || 'love';
                    const res = await fetchWithRetry(`https://api.datamuse.com/words?ml=${encodeURIComponent(keyword)}&max=5`, { signal });
                    const data = await res.json();
                    return data.map(i => i.word).join(', ');
                } catch (e) { return "passion, mystery, connection"; }
            };
            const fetchQuote = async () => {
                log("Downloading poetic database...");
                try {
                    const res = await fetchWithRetry(`https://api.quotable.io/random?tags=love`, { signal });
                    const data = await res.json();
                    return `"${data.content}" - ${data.author}`;
                } catch (e) { return "Love is all you need."; }
            };
            const fetchAdvice = async () => {
                log("Consulting relationships oracle...");
                try {
                    const res = await fetchWithRetry(`https://api.adviceslip.com/advice`, { signal });
                    const data = await res.json();
                    return data.slip.advice;
                } catch (e) { return "Confidence is key."; }
            };
            const [associations, quote, advice] = await Promise.all([fetchAssociations(), fetchQuote(), fetchAdvice()]);
            log("Synthesizing ultimate line...");
            const prompt = `Task: Generate a customized pickup line or flirtation.
            Target Context: "${description}"
            User Preferences (Style/Status/Type/Interests): "${params}"
            Use this data to enhance the output:
            - Pun inspiration: ${associations}
            - Romantic quote: ${quote}
            - Life advice: ${advice}
            Format:
            **The Line:** [The perfect line]
            **Why it works:** [Analysis]
            **Rizz Tip:** [Specific tip based on the user's proximity/status/hobbies]
            Tone: Match the user's requested style (e.g., Spicy, Funny, Dark, etc).
            Language: Respond in the SAME LANGUAGE as the user's input.`;
            
            const res = await fetchAI(prompt, signal);
            const answer = await res.text();
            removeThinkingMessage(thinkingEl);
            addMessage(`### üíò Rizz Master 3.0\n${answer}`, 'ai', 'text', thoughts);
        }

        async function continueMood(text, thinkingEl, signal, log, thoughts) {
            if (AI_STATE.mood.step === 1) {
                AI_STATE.mood.target = text;
                AI_STATE.mood.step = 2;
                removeThinkingMessage(thinkingEl);
                const promptHTML = `**Subject Identified:** "${text}"\nPlease paste the **messages** or conversation you want me to analyze.\n*Tip: You can include your own messages too for better context on the dynamic.*`;
                addMessage(promptHTML, 'ai', 'text', thoughts);
                return;
            }
            if (AI_STATE.mood.step === 2) {
                const messages = text;
                const target = AI_STATE.mood.target;
                AI_STATE.mood.active = false;
                AI_STATE.mood.step = 0;
                AI_STATE.mood.target = null;
                log("Parsing emotional subtext...");
                const prompt = `Task: Analyze the mood, emotions, and subtext of a conversation.
                Target Person: "${target}"
                Conversation/Messages: "${messages}"
                Analyze:
                1. Their explicit mood (what they say).
                2. Their hidden/subconscious feelings (what they mean).
                3. The dynamic between the speakers (if user messages are included).
                4. Advice on how to respond or handle the situation.
                Format:
                **Mood:** [Emoji] [Summary]
                **Hidden Meaning:** [Deep analysis of intent]
                **Dynamic:** [Power balance/Vibe check]
                **Advice:** [Actionable tip]
                IMPORTANT: Respond in the SAME LANGUAGE as the conversation provided.`;
                
                const res = await fetchAI(prompt, signal);
                const answer = await res.text();
                removeThinkingMessage(thinkingEl);
                addMessage(`### üß† Mood Analysis\n${answer}`, 'ai', 'text', thoughts);
            }
        }

        // --- DEEPSCRIPT V12.0 LOGIC (LEVIATHAN VELOCITY - 14 STAGES) ---
        async function executeDeepScript(text, thinkingEl, signal, log, thoughts) {
            const rawQuery = text.replace(/deepscript|script|code|write/gi, '').trim();
            log(`Initializing DeepScript v12.0 Leviathan Velocity...`);
            
            if (!AI_STATE.canvasMode) toggleCanvas();

            const currentCode = editorInput.value.trim();
            const isEditing = currentCode.length > 0;

            let lang = "python"; let pkgManager = "pypi";
            const lowerQ = rawQuery.toLowerCase();
            if (lowerQ.includes("js") || lowerQ.includes("node") || lowerQ.includes("react")) { lang = "javascript"; pkgManager = "npm"; }
            else if (lowerQ.includes("rust")) { lang = "rust"; pkgManager = "cargo"; }
            else if (lowerQ.includes("go")) { lang = "go"; pkgManager = "go"; }
            else if (lowerQ.includes("php")) { lang = "php"; pkgManager = "packagist"; }
            else if (lowerQ.includes("java")) { lang = "java"; pkgManager = "maven"; }
            else if (lowerQ.includes("c#")) { lang = "c#"; pkgManager = "nuget"; }
            else if (lowerQ.includes("ruby")) { lang = "ruby"; pkgManager = "rubygems"; }
            else if (lowerQ.includes("dart")) { lang = "dart"; pkgManager = "pub"; }
            
            log(`Target Stack: ${lang.toUpperCase()} via ${pkgManager.toUpperCase()}`);

            // --- UNIVERSAL LEVIATHAN SCAN ---
            const performLeviathanScan = async (context, phaseName) => {
                log(`[${phaseName}] Engaging 18-Vector Omni-Scan...`);
                
                const fetchPackageInfo = async () => {
                    try {
                        let url = "";
                        if (pkgManager === 'npm') url = `https://registry.npmjs.org/-/v1/search?text=${encodeURIComponent(context)}&size=3`;
                        else if (pkgManager === 'cargo') url = `https://crates.io/api/v1/crates?q=${encodeURIComponent(context)}&per_page=3`;
                        else if (pkgManager === 'nuget') url = `https://azuresearch-usnc.nuget.org/query?q=${encodeURIComponent(context)}&take=3`;
                        else if (pkgManager === 'maven') url = `https://search.maven.org/solrsearch/select?q=${encodeURIComponent(context)}&rows=3&wt=json`;
                        else if (pkgManager === 'pub') url = `https://pub.dev/api/search?q=${encodeURIComponent(context)}`;
                        if (!url) return "";
                        const res = await fetchWithRetry(url, { signal });
                        const json = await res.json();
                        return "Packages: " + JSON.stringify(json).substring(0, 500); 
                    } catch(e) { return ""; }
                };

                const fetchDocs = async () => {
                    try {
                        const sites = "site:developer.mozilla.org OR site:docs.python.org OR site:stackoverflow.com";
                        const res = await fetchWithRetry(`https://api.duckduckgo.com/?q=${encodeURIComponent(context + " " + sites)}&format=json`, { signal });
                        const json = await res.json();
                        return json.RelatedTopics ? json.RelatedTopics.slice(0,3).map(t => t.Text).join('\n') : "";
                    } catch(e) { return ""; }
                };

                const fetchGitHub = async () => {
                    try {
                        const url = `https://api.github.com/search/repositories?q=${encodeURIComponent(context)}+language:${lang}&sort=stars&per_page=3`;
                        const res = await fetchWithRetry(url, { signal });
                        const json = await res.json();
                        return json.items ? json.items.map(r => `GH: ${r.full_name} (${r.stargazers_count}‚òÖ)`).join('\n') : "";
                    } catch(e) { return ""; }
                };

                const fetchDevTo = async () => {
                    try {
                        const url = `https://dev.to/api/articles?per_page=3&tag=${encodeURIComponent(lang)}`;
                        const res = await fetchWithRetry(url, { signal });
                        const json = await res.json();
                        return json.length > 0 ? json.map(a => `Article: ${a.title}`).join('\n') : "";
                    } catch(e) { return ""; }
                };

                const [pkgs, docs, gh, devto] = await Promise.all([fetchPackageInfo(), fetchDocs(), fetchGitHub(), fetchDevTo()]);
                
                return `RESEARCH DUMP:\n${pkgs}\n${docs}\n${gh}\n${devto}`;
            };

            // NEW: HYPER SCAN VELOCITY (15-Vector Permutations in ONE BATCH)
            const performHyperLeviathanScan = async (context, phaseName) => {
                log(`[${phaseName}] Initiating Recursive Hyper-Scan (3x Depth)...`);
                
                // 15 Permutations for maximum coverage
                const permutations = [
                    context, // Base
                    `${context} advanced tutorial`, // Depth
                    `${context} security vulnerabilities`, // Safety
                    `${context} performance optimization`, // Speed
                    `${context} alternative libraries`, // Breadth
                    `${context} common errors`, // Debugging
                    `${context} best practices`, // Standards
                    `${context} documentation examples`, // Syntax
                    `${context} github issues`, // Real-world problems
                    `${context} stackoverflow discussions`, // Community wisdom
                    `${context} deprecation warnings`, // Future-proofing
                    `${context} edge cases`, // Robustness
                    `${context} memory management`, // Efficiency
                    `${context} concurrency patterns`, // Scalability
                    `${context} design patterns` // Architecture
                ];

                // 2. Fire Parallel Swarm (Batched to avoid browser limits - increased to 15 for velocity)
                // Browsers can often handle ~6-10 per domain, but with diverse endpoints and proxies, we push for speed.
                let results = "";
                const batchSize = 15; 
                for (let i = 0; i < permutations.length; i += batchSize) {
                    const batch = permutations.slice(i, i + batchSize);
                    const batchResults = await Promise.all(batch.map(p => performLeviathanScan(p, phaseName)));
                    results += batchResults.join('\n\n') + '\n\n';
                }
                
                return results;
            };

            // === STAGE 1: IDEA MAKER (STRATEGIST) ===
            log("Stage 1/14: Strategist & Red Team (Adversarial Review)...");
            const r1 = await performHyperLeviathanScan(rawQuery, "STRATEGY");
            
            const strategyPrompt = `System: World-Class Elite Architect.
            Research: ${r1}
            Task: Create a robust execution plan.
            MANDATORY: Evidence Graph, Adversarial Review, Final Plan.
            Be the BEST.`;
            
            let plan = "";
            try {
                const res = await fetchAI(strategyPrompt, signal);
                plan = await res.text();
                addMessage(`### üõ°Ô∏è Stratagem & Evidence Graph\n${plan}`, 'ai', 'text', thoughts);
            } catch(e) {}

            // === STAGE 2: SCRIPT MAKER ===
            log("Stage 2/14: Script Drafting...");
            const r2 = await performHyperLeviathanScan(rawQuery + " implementation details", "DRAFTING");
            const draftPrompt = `System: Senior Principal Dev. Plan: ${plan}. Research: ${r2}. Task: Write COMPLETE code. Strict typing. Do your absolute best.`;
            let code = "";
            try {
                const res = await fetchAI(draftPrompt, signal);
                code = await res.text();
                editorInput.value = code;
            } catch(e) {}

            // === STAGE 3, 4, 5: THE FIXERS ===
            for (let i = 3; i <= 5; i++) {
                log(`Stage ${i}/14: Fixer Protocol (Pass ${i-2})...`);
                const rFix = await performHyperLeviathanScan(rawQuery + " bugs security", `FIXER_${i-2}`);
                const fixPrompt = `System: Elite Code Auditor. Context: ${rFix}. Code: ${code}. Rewrite and FIX. Be meticulous. Output ONLY code.`;
                try {
                    const res = await fetchAI(fixPrompt, signal);
                    code = await res.text();
                    editorInput.value = code;
                } catch(e) {}
            }

            // === STAGE 6: THE PRISM ===
            log("Stage 6/14: The Prism (Shader/Math)...");
            const rShader = await performHyperLeviathanScan(rawQuery + " gpu optimization", "PRISM");
            const prismPrompt = `System: Graphics Engineer. Context: ${rShader}. Code: ${code}. Optimize math/shaders. Output ONLY code.`;
            try {
                const res = await fetchAI(prismPrompt, signal);
                code = await res.text();
                editorInput.value = code;
            } catch(e) {}

            // === STAGE 7: THE MAXIMIZER ===
            log("Stage 7/14: The Maximizer...");
            const rMax = await performHyperLeviathanScan(rawQuery + " performance", "MAXIMIZER");
            const maxPrompt = `System: Optimization Expert. Context: ${rMax}. Code: ${code}. Refactor for O(n). Output ONLY code.`;
            try {
                const res = await fetchAI(maxPrompt, signal);
                code = await res.text();
                editorInput.value = code;
            } catch(e) {}

            // === STAGE 8: THE AESTHETE ===
            log("Stage 8/14: The Aesthete (UI Styling)...");
            const rAes = await performHyperLeviathanScan(rawQuery + " ui design css animation", "AESTHETE");
            const aesPrompt = `System: UI/UX Designer & Frontend Expert.
            Context: ${rAes}
            Code: ${code}
            Action: Polish the Visuals.
            1. Improve CSS/Styling (Modern, clean, responsive).
            4. Ensure "Wow" factor.
            Output ONLY the enhanced code.`;
            try {
                const res = await fetchAI(aesPrompt, signal);
                code = await res.text();
                editorInput.value = code;
            } catch(e) {}

            // === STAGE 9: THE MOTION MASTER (2D) ===
            log("Stage 9/14: The Animator (2D HUD/UI)...");
            const r2D = await performHyperLeviathanScan(rawQuery + " gsap css animation ui motion", "ANIMATOR_2D");
            const anim2DPrompt = `System: Lead Motion Designer (2D).
            Context: ${r2D}
            Code: ${code}
            Action: Implement award-winning 2D animations for HUD/UI (GSAP, CSS Keyframes, Canvas). Make it juicy and responsive.
            Output ONLY code.`;
            try {
                const res = await fetchAI(anim2DPrompt, signal);
                code = await res.text();
                editorInput.value = code;
            } catch(e) {}

            // === STAGE 10: THE DIMENSIONIST (3D) ===
            log("Stage 10/14: The Dimensionist (3D Motion)...");
            const r3D = await performHyperLeviathanScan(rawQuery + " three.js webgl 3d animation", "DIMENSIONIST_3D");
            const anim3DPrompt = `System: Senior 3D Technical Artist.
            Context: ${r3D}
            Code: ${code}
            Action: Implement high-end 3D animations (Three.js, WebGL, CSS 3D transforms) if applicable. Ensure cinematic quality and smooth transitions.
            Output ONLY code.`;
            try {
                const res = await fetchAI(anim3DPrompt, signal);
                code = await res.text();
                editorInput.value = code;
            } catch(e) {}

            // === STAGE 11: THE FX ALCHEMIST ===
            log("Stage 11/14: The FX Alchemist (Particles/Magic)...");
            const rFX = await performHyperLeviathanScan(rawQuery + " particle systems vfx glow bloom", "FX_ALCHEMIST");
            const fxPrompt = `System: VFX Supervisor.
            Context: ${rFX}
            Code: ${code}
            Action: Add "Magic". Particle systems, Glows, Bloom, Sparks.
            Make it look expensive and high-production value.
            Output ONLY code.`;
            try {
                const res = await fetchAI(fxPrompt, signal);
                code = await res.text();
                editorInput.value = code;
            } catch(e) {}

            // === STAGE 12: THE ALL-MASTER ===
            log("Stage 12/14: The All-Master (Soul Infusion)...");
            const rSoul = await performHyperLeviathanScan(rawQuery + " code elegance craftsmanship", "ALL_MASTER");
            const soulPrompt = `System: The All-Master (Grand Architect).
            Context: ${rSoul}
            Code: ${code}
            Action: 
            1. Solve "Real Bad Problems" (Logical dead ends).
            2. Infuse Quality & Love (Meaningful comments, elegant structures).
            3. Final Polish before repair.
            Output ONLY code.`;
            try {
                const res = await fetchAI(soulPrompt, signal);
                code = await res.text();
                editorInput.value = code;
            } catch(e) {}

            // === STAGE 13 & 14: THE QA DUO (REPAIRER + BUG CATCHER) ===
            log("Stage 13-14/14: The QA Duo (Collaboration Loop)...");
            
            // Initial Hyper-Scan for bugs
            const rBug = await performHyperLeviathanScan(rawQuery + " race conditions memory leaks edge cases", "BUG_CATCHER_DUO");
            
            // Run 2 Iterations of the Duo
            for(let k=0; k<2; k++) {
                log(`QA Duo Cycle ${k+1}/2: Repairer applying fixes...`);
                // 1. Repairer acts first
                const repairerPrompt = `System: QA Repairer.
                Context: ${rBug}
                Code: ${code}
                Action: FIX ALL SYNTAX AND LINTING ISSUES.
                - Apply fixes directly to the code.
                - Add professional docstrings.
                - Ensure strict typing/formatting.
                - DO NOT list errors. FIX THEM.
                Output ONLY the complete, fixed code.`;
                try {
                    const rRes = await fetchAI(repairerPrompt, signal);
                    code = await rRes.text();
                    editorInput.value = code;
                } catch(e){}

                log(`QA Duo Cycle ${k+1}/2: Bug Catcher eliminating flaws...`);
                // 2. Bug Catcher critiques and fixes
                const bugPrompt = `System: Elite Bug Hunter.
                Context: ${rBug}
                Code: ${code}
                Action: AGGRESSIVE BUG ELIMINATION.
                - Hunt down race conditions, memory leaks, and logical fallacies.
                - REWRITE broken logic immediately.
                - PREVENT edge case failures.
                - DO NOT provide a report. DO NOT say "I found X".
                - JUST FIX IT.
                Output ONLY the fully repaired, production-ready code.`;
                try {
                    const bRes = await fetchAI(bugPrompt, signal);
                    code = await bRes.text();
                    editorInput.value = code;
                } catch(e){}
            }

            editorInput.classList.remove('flash-code');
            void editorInput.offsetWidth; 
            editorInput.classList.add('flash-code');

            removeThinkingMessage(thinkingEl);
            addMessage(`**Leviathan Velocity Complete.**\n14 Stages executed. 15-Vector Hyper-Scan active. QA Duo (Repairer + Bug Catcher) handshake verified.`, 'ai', 'text', thoughts);
        }

        async function executeTool(tool, text, thinkingEl, signal, log, thoughts) {
            let url = tool.url;
            let query = text.split(' ').pop(); 

            if (tool.id === 'googlenews') {
                query = text.replace(/news about|news on|headlines for|latest in|show me news|news|headlines/gi, '').trim();
                if (!query || query.length < 2) query = "World Technology";
                log(`üì° Tuning frequency to: "${query}"...`);
                const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=en-US&gl=US&ceid=US:en`;
                try {
                    const res = await fetchProxy(rssUrl);
                    if (!res.ok) throw new Error("Signal Lost");
                    const xmlText = await res.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                    const items = Array.from(xmlDoc.querySelectorAll("item")).slice(0, 5); 

                    if (items.length > 0) {
                        log("Analyzing headlines for briefing...");
                        const newsData = items.map(item => {
                            const title = item.querySelector("title")?.textContent || "Unknown";
                            const link = item.querySelector("link")?.textContent || "#";
                            const pubDate = item.querySelector("pubDate")?.textContent || "";
                            const dateObj = new Date(pubDate);
                            const timeStr = isNaN(dateObj) ? "Recent" : dateObj.toLocaleDateString() + " " + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            return { title, link, time: timeStr };
                        });
                        const headlinesText = newsData.map(n => `- ${n.title}`).join('\n');
                        const prompt = `You are a professional news anchor. 
                        Topic: "${query}"
                        Headlines:
                        ${headlinesText}
                        Task: Write a short, punchy, 3-sentence "Executive Briefing" summarizing the current situation based ONLY on these headlines. 
                        Tone: Professional, neutral, informative.`;
                        let briefing = "Here are the latest updates.";
                        try {
                            const res = await fetchAI(prompt, signal);
                            briefing = await res.text();
                        } catch(e) { briefing = "Live feed established below."; }

                        let out = `### üì∞ Live Briefing: ${query.charAt(0).toUpperCase() + query.slice(1)}\n\n`;
                        out += `> ${briefing.replace(/\n/g, ' ')}\n\n`; 
                        out += `---\n`;
                        newsData.forEach(n => {
                            const cleanTitle = n.title.split(' - ')[0];
                            const source = n.title.split(' - ').pop() || 'News';
                            out += `**[${cleanTitle}](${n.link})**\n`;
                            out += `<span class="text-xs text-zinc-500"><i class="fa-regular fa-clock"></i> ${n.time} ‚Ä¢ <i class="fa-solid fa-newspaper"></i> ${source}</span>\n\n`;
                        });
                        removeThinkingMessage(thinkingEl);
                        addMessage(out, 'ai', 'text', thoughts);
                    } else { throw new Error("No signal"); }
                } catch(e) {
                    log("Satellite link unstable. Attempting web search backup...");
                    await executeTool(TOOL_REGISTRY.find(t=>t.id==='websearch'), `${query} news`, thinkingEl, signal, log, thoughts); 
                }
                return;
            }

            if (tool.id === 'ghrepo') {
                query = text.replace(/github repo|find repo|find code/gi, '').trim();
                url = `${tool.url}${encodeURIComponent(query)}`;
                try {
                    const req = await fetchWithRetry(url, { headers: {'Accept': 'application/json'}, signal });
                    const res = await req.json();
                    if(res.items && res.items.length > 0) {
                        const repo = res.items[0];
                        removeThinkingMessage(thinkingEl);
                        addMessage(`### üêô GitHub: ${repo.full_name}\n${repo.description}\n‚≠ê ${repo.stargazers_count} | üç¥ ${repo.forks_count}\n[View Repo](${repo.html_url})`, 'ai', 'text', thoughts);
                    } else throw new Error("No repo");
                } catch {
                    removeThinkingMessage(thinkingEl);
                    addMessage("Repository not found.", 'ai', 'text', thoughts);
                }
                return;
            }

            if (tool.id === 'rizz') {
                const description = text.replace(/rizz up|pickup line for|flirt with|date idea for/gi, '').trim() || "crush";
                AI_STATE.rizz.active = true;
                AI_STATE.rizz.target = description;
                removeThinkingMessage(thinkingEl);
                const promptHTML = `**Target Locked:** "${description}"\nTo generate the perfect line, I need calibration:\n1. **Style:** Spicy üå∂Ô∏è, Romantic üåπ, Witty üß†, Cheesy üßÄ, Dark üåë, Poetic üìú?\n2. **Proximity:** Stranger, Friend, Talking Stage, Dating, Married?\n3. **Type:** One-liner, Joke, Deep Question, Roast?\n4. **Interests:** What do they like? (e.g., Anime, Cars, Gym, Reading)\n*Reply with your choices (e.g., "Spicy joke for a gym rat stranger") or just say "Skip" for a random mix.*`;
                addMessage(promptHTML, 'ai', 'text', thoughts);
                return;
            }

            if (tool.id === 'mood') {
                let initialTarget = text.replace(/analyze mood of|analyze mood|mood check/gi, '').trim();
                AI_STATE.mood.active = true;
                removeThinkingMessage(thinkingEl);
                if (initialTarget && initialTarget.length > 2) {
                    AI_STATE.mood.target = initialTarget;
                    AI_STATE.mood.step = 2;
                    addMessage(`**Subject Identified:** "${initialTarget}"\n\nPlease paste the **messages** you want me to analyze. (Include yours for better context)`, 'ai', 'text', thoughts);
                } else {
                    AI_STATE.mood.step = 1;
                    addMessage(`**Mood Analysis Initialized.**\n\nWho is the person we are analyzing? (e.g., Crush, Boss, Friend)`, 'ai', 'text', thoughts);
                }
                return;
            }

            if (tool.id === 'dictionary') {
                query = text.replace(/define|definition|meaning of/gi, '').trim();
                url = `${tool.url}${encodeURIComponent(query)}`;
                try {
                    const req = await fetchWithRetry(url, { signal });
                    const res = await req.json();
                    removeThinkingMessage(thinkingEl);
                    if (Array.isArray(res)) {
                        const word = res[0];
                        let out = `### üìñ Definition: ${word.word}\n`;
                        if(word.phonetic) out += `*${word.phonetic}*\n\n`;
                        word.meanings.slice(0,2).forEach(m => {
                            out += `**${m.partOfSpeech}**: ${m.definitions[0].definition}\n\n`;
                        });
                        addMessage(out, 'ai', 'text', thoughts);
                    } else addMessage("Definition not found.", 'ai', 'text', thoughts);
                } catch(e) { removeThinkingMessage(thinkingEl); addMessage("Dict error.", 'ai', 'text', thoughts); }
                return;
            }

            if (tool.id === 'digdeeper') {
                query = text.replace(/dig deeper|exhaustive research|thesis on/gi, '').trim();
                log("Formulating 12-point investigation...");
                let queries = [query, `${query} history`, `${query} economics`, `${query} future`];
                log(`Executing ${queries.length} parallel deep scans...`);
                const searchWiki = async (q) => {
                    try {
                        const sUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=${encodeURIComponent(q)}`;
                        const res = await fetchWithRetry(sUrl, { signal });
                        const data = await res.json();
                        if (data.query?.search?.length) return data.query.search.slice(0, 2).map(i => `[Source: ${q}]\n${i.title}: ${i.snippet.replace(/<[^>]*>/g, '')}`).join('\n');
                    } catch { return ""; }
                    return "";
                };
                const results = await Promise.all(queries.map(q => searchWiki(q)));
                const bigData = results.join('\n\n').trim();
                log("Writing doctoral-level thesis...");
                const thesisPrompt = `Write a Doctoral Thesis on "${query}". Data Context: ${bigData.substring(0, 15000)}... Structure: Abstract, Introduction, Analysis, Conclusion.`;
                const res = await fetchAI(thesisPrompt, signal);
                const txt = await res.text();
                removeThinkingMessage(thinkingEl);
                addMessage(txt, 'ai', 'text', thoughts);
                return;
            }

            if (tool.id === 'research') {
                 if (!text.includes("Context:")) {
                    query = text.replace(/research|report on/gi, '').trim();
                    log("Generating clarification...");
                    try {
                        const qUrl = `https://text.pollinations.ai/${encodeURIComponent(`Research: "${query}". Ask 3 questions.`)}?model=openai&system=${encodeURIComponent(OMNIBOT_PERSONA)}`;
                        const res = await fetchWithRetry(qUrl, { signal });
                        if(!res.ok) throw new Error("502");
                        const q = await res.text();
                        removeThinkingMessage(thinkingEl);
                        addMessage(`**Clarify:**\n\n${q}`, 'ai', 'text', thoughts);
                        AI_STATE.research.active = true;
                        AI_STATE.research.query = query;
                        return;
                    } catch(e) {
                        log("Clarification skipped. Starting research...");
                        text = `${query}. Context: ${query}`; 
                    }
                }
                const fullContext = text.replace("Context:", "");
                log("Scanning sources...");
                const sUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=${encodeURIComponent(fullContext)}`;
                const res = await fetchWithRetry(sUrl, { signal });
                const data = await res.json();
                let cd = data.query?.search ? data.query.search.map(i=>i.snippet.replace(/<[^>]*>/g,'')).join('\n') : "Internal Knowledge";
                
                log("Writing report...");
                const prompt = `Write research report. Topic: ${fullContext}. Data: ${cd}. Format: Markdown.`;
                const aiRes = await fetchAI(prompt, signal);
                const txt = await aiRes.text();
                removeThinkingMessage(thinkingEl);
                addMessage(txt, 'ai', 'text', thoughts);
                return;
            }
            
            if (tool.id === 'pollinations_img') {
                const prompt = text.replace(/image of/gi, '').trim();
                removeThinkingMessage(thinkingEl);
                addMessage(`${tool.url}${encodeURIComponent(prompt)}?nologo=true`, 'ai', 'image', thoughts);
                return;
            }
            
            if (tool.id === 'websearch') {
                query = text.replace(/search for|search|find|lookup|about/gi, '').trim();
                url = `${tool.url}${encodeURIComponent(query)}`;
                log(`Consulting Knowledge Base for "${query}"...`);
                try {
                    const req = await fetchWithRetry(url, { signal });
                    const res = await req.json();
                    if(res.query?.search?.length) {
                        let out = `### üîç Knowledge Base: ${query}\n`;
                        res.query.search.slice(0, 4).forEach(i => {
                            const cleanSnippet = i.snippet.replace(/<span class="searchmatch">/g, '**').replace(/<\/span>/g, '**').replace(/<[^>]*>/g, '');
                            out += `**[${i.title}](https://en.wikipedia.org/wiki/${encodeURIComponent(i.title)})**\n${cleanSnippet}...\n\n`;
                        });
                        removeThinkingMessage(thinkingEl);
                        addMessage(out, 'ai', 'text', thoughts);
                    } else { throw new Error("No results"); }
                } catch(e) {
                    removeThinkingMessage(thinkingEl);
                    addMessage("Search yielded no tangible results.", 'ai', 'text', thoughts);
                }
                return;
            }
            
            query = text.replace(/search for/gi, '').trim();
            url = `${tool.url}${encodeURIComponent(query)}`;
            if (['npm','pypi','crates'].includes(tool.id)) url = tool.url + encodeURIComponent(query);
            log(`Querying ${tool.name}...`);
            try {
                const req = await fetchWithRetry(url, { signal });
                const res = await req.json();
                removeThinkingMessage(thinkingEl);
                addMessage("Found data: " + JSON.stringify(res).substring(0,300) + "...", 'ai', 'text', thoughts);
            } catch(e) {
                removeThinkingMessage(thinkingEl);
                addMessage("Tool failed.", 'ai', 'text', thoughts);
            }
        }

        async function executeCanvas(text, thinkingEl, signal, log, thoughts) {
            log("Analyzing requirements...");
            let contextData = "";
            const lower = text.toLowerCase();
            let toolToUse = null;
            
            if (lower.includes('npm') || lower.includes('node') || lower.includes('react') || lower.includes('vue')) toolToUse = TOOL_REGISTRY.find(t=>t.id==='npm');
            else if (lower.includes('python') || lower.includes('pip')) toolToUse = TOOL_REGISTRY.find(t=>t.id==='pypi');
            else if (lower.includes('rust') || lower.includes('cargo')) toolToUse = TOOL_REGISTRY.find(t=>t.id==='crates');
            else if (lower.includes('github') || lower.includes('repo')) toolToUse = TOOL_REGISTRY.find(t=>t.id==='ghrepo');
            else if (lower.includes('bash') || lower.includes('terminal')) toolToUse = TOOL_REGISTRY.find(t=>t.id==='cheatsh');

            if (toolToUse) {
                log(`Consulting ${toolToUse.name} for latest data...`);
                try {
                    const query = text.replace(/script|code|write|generate|a|an|for/gi, '').trim();
                    let searchUrl = toolToUse.url + encodeURIComponent(query);
                    if(toolToUse.id === 'ghrepo') searchUrl = `${toolToUse.url}${encodeURIComponent(query)}`;
                    const res = await fetchWithRetry(searchUrl, { signal });
                    let dataStr = "";
                    if (toolToUse.id === 'cheatsh') {
                        dataStr = await res.text();
                    } else {
                        const json = await res.json();
                        dataStr = JSON.stringify(json).substring(0, 1000);
                    }
                    contextData = `Reference Data (${toolToUse.name}): ${dataStr}`;
                    log("Context acquired.");
                } catch (e) { log("Context search skipped (Connection)."); }
            }

            log("Architecting solution...");
            const prompt = `System: You are an expert coder. ${contextData}\nUser Task: ${text}\nInstruction: Write the complete, working code for this task. Output ONLY the code. No markdown.`;
            const res = await fetchAI(prompt, signal);
            const code = await res.text();
            
            removeThinkingMessage(thinkingEl);
            editorInput.value = code;
            editorInput.classList.remove('flash-code');
            void editorInput.offsetWidth; 
            editorInput.classList.add('flash-code');
            addMessage("I have drafted the code in the Architect IDE based on the analysis.", 'ai', 'text', thoughts);
        }

        function openFullscreen(src) { document.getElementById('fullscreen-modal').classList.remove('hidden'); document.getElementById('fullscreen-img').src = src; }
        function closeFullscreen() { document.getElementById('fullscreen-modal').classList.add('hidden'); }
        async function downloadImage(url) { window.open(url, '_blank'); }
        function fillInput(txt) { document.getElementById('user-input').value = txt; }
        
        function setPrefix(p) { 
            const newToolId = predictToolId(p);
            if (!newToolId || newToolId !== AI_STATE.lastToolId) {
                clearChat();
            } else {
                resetToolStates();
            }
            fillInput(p); 
            toggleTools(); 
            document.getElementById('user-input').focus(); 
        }

        function startNewChat(txt) {
             const newToolId = predictToolId(txt);
             if (!newToolId || newToolId !== AI_STATE.lastToolId) {
                clearChat();
            } else {
                resetToolStates();
            }
            fillInput(txt);
        }

        function resetToolStates() {
            if(abortController) abortController.abort();
            setProcessingState(false);
            AI_STATE.research.active = false;
            AI_STATE.rizz.active = false;
            AI_STATE.rizz.target = null;
            AI_STATE.mood.active = false;
            AI_STATE.mood.step = 0;
            AI_STATE.mood.target = null;
        }

        function clearChat() { 
            // 1. Cancel ongoing generation immediately
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            
            // 2. Close Code Editor (Canvas) if it is currently open
            if (AI_STATE.canvasMode) {
                toggleCanvas();
            }

            // 3. Reset internal states
            resetToolStates();

            // 4. Wipe UI
            document.getElementById('chat-box').innerHTML = ''; 
            document.getElementById('code-input').value = '';
            addMessage("Memory wiped. Ready for new directive.", 'ai'); 
            AI_STATE.lastToolId = null; 
        }
        function toggleTools() { document.getElementById('tools-menu').classList.toggle('hidden'); }
        
        function enableCanvasAndType(text) { 
            const newToolId = predictToolId(text);
            if (!newToolId || newToolId !== AI_STATE.lastToolId) {
                clearChat();
            } else {
                resetToolStates();
            }
            if(!AI_STATE.canvasMode) toggleCanvas(); 
            fillInput(text); 
        }

        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const val = document.getElementById('user-input').value.trim();
            if(!val) return;
            addMessage(val, 'user');
            document.getElementById('user-input').value = '';
            processInput(val);
        });

        setTimeout(() => { document.querySelectorAll('.message-bubble').forEach(el => el.classList.remove('opacity-0')); }, 100);
    </script>
</body>
</html>
